<!DOCTYPE html>
<html >
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>A simple HTTP/2 server using Vapor 4 - </title>
    <meta name="description" content="Get started with server-side Swift using the Vapor 4 framework. Learn how to build a really simple HTTP/2 backend server.">
    
    <meta property="og:url" content="/posts/a-simple-http2-server-using-vapor-4/">
    <meta property="og:title" content="A simple HTTP/2 server using Vapor 4 - ">
    <meta property="og:description" content="Get started with server-side Swift using the Vapor 4 framework. Learn how to build a really simple HTTP/2 backend server.">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="A simple HTTP/2 server using Vapor 4 - ">
    <meta name="twitter:description" content="Get started with server-side Swift using the Vapor 4 framework. Learn how to build a really simple HTTP/2 backend server.">
    
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <link rel="shortcut icon" href="/images/icons/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/images/icons/icon-320.png" type="image/png">
    
    <link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="57x57" href="/images/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon-180x180.png">

</head>

<body>
    <header id="navigation">
        <a id="site-logo" href="">
            <figure>
                <picture>
                    <source
                        srcset="/images/logos/logo~dark.png"
                        media="(prefers-color-scheme: dark)"
                    >
                    <img
                        id="logo-image"
                        src="/images/logos/logo.png"
                        alt="Logo of "
                        title=""
                    >
                </picture>
            </figure>
        </a>
    
        <nav id="primary-menu">
            <input type="checkbox" id="primary-menu-button" name="menu-button" class="menu-button">
            <label for="primary-menu-button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </label>
            <div class="menu-items">
                <a href="/">Home</a>
                <a href="/blog/">Blog</a>
                <a href="/posts/pages/1/">Posts</a>
                <a href="/authors/">Authors</a>
                <a href="/tags/">Tags</a>
                <a href="/my-page/">My page</a>
            </div>
        </nav>
    
        <nav id="secondary-menu">
            <input type="checkbox" id="secondary-menu-button" name="menu-button" class="menu-button">
            <label for="secondary-menu-button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="12" cy="5" r="1"></circle>
                    <circle cx="12" cy="19" r="1"></circle>
                </svg>
            </label>
            <div class="menu-items right">
                <a href="#">My account</a>
                <a href="/">Logout</a>
            </div>
        </nav>
    </header>
        
    <main>

<article>
    <header>
        <section id="post-header" class="content-wrapper">
            <time datetime="2019-10-08 16:20:00">2019-10-08 16:20:00</time>
            <h1 class="title">A simple HTTP/2 server using Vapor 4</h1>
            <p class="excerpt">Get started with server-side Swift using the Vapor 4 framework. Learn how to build a really simple HTTP/2 backend server.</p>
        </section>
        
    </header>

    <section id="contents" class="content-wrapper">
    
    <h2>What is HTTP/2?</h2><p>In short, it‚Äôs the second major version of <a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol" target="_blank">Hypertext Transfer Protocol</a> (HTTP), but obviously you‚Äôre not here for the short version. <a href="https://en.wikipedia.org/wiki/HTTP/2" target="_blank">HTTP/2</a> is a huge upgrade, it was derived from the experimental <a href="https://en.wikipedia.org/wiki/SPDY" target="_blank">SPDY</a> protocol, nowadays it‚Äôs <a href="https://w3techs.com/technologies/details/ce-http2/all/all" target="_blank">widely used by about 40% of all the websites</a>. Yes it‚Äôs time to upgrade your infrastructure (soon). üòâ</p><h3>HTTP</h3><p>The HTTP protocol is basically a client-server (request-response) communication protocol where the client asks for a resource and the server returns a response (a HTML document, a stylesheet, a JavaScript file, or anything else‚Ä¶). This all happens on top of a TCP/IP connection layer using sockets. If you don‚Äôt know anything about <a href="http://www.steves-internet-guide.com/tcpip-ports-sockets/" target="_blank">TCP/IP ports and sockets</a>, you should read the linked article.</p><blockquote><p>NOTE: HTTP2 is secure by default, so it only works via TLS/SSL, but for the sake of simplicity I‚Äôm not going into the details of HTTPS, cryptography or secure connection.</p></blockquote><p>HTTP is an application layer protocol, that describes how you can interact with various resources identified by an <a href="https://prateekvjoshi.com/2014/02/22/url-vs-uri-vs-urn/" target="_blank">URL/URI (or URN)</a>. HTTP is simple (a few methods like GET, POST), yet extensible (via headers), stateless, but not sessionless (just think about Cookies) and it‚Äôs definitely dominating the world wide web (browsers). üåé</p><p>HTTP version 1.1 has some disadvantages. It is a text based unencrypted protocol, plus as websites evolved and more and more resources were needed in order to render a webpage, HTTP/1.1 started to face some speed issues, because you are only allowed to download only one resource at a time on a <a href="https://medium.com/@factoryhr/http-2-the-difference-between-http-1-1-benefits-and-how-to-use-it-38094fa0e95b" target="_blank">HTTP/1.1</a> connection.</p><blockquote><p>You have to wait for it‚Ä¶</p></blockquote><h3>Request multiplexing</h3><p>The best (and most advanced feature) of <a href="https://developers.google.com/web/fundamentals/performance/http2" target="_blank">HTTP/2</a> is <a href="https://stackoverflow.com/questions/36517829/what-does-multiplexing-mean-in-http-2" target="_blank">request multiplexing</a>. It allows you to download multiple files asynchronously from the server. This enables browsers and other applications to think about loading resources in a nice promie-like way instead of the old-fashioned blocking connection. You can send all your requests on the same connection and they can be fulfilled in parallel. üöÄ</p><h3>Server Push</h3><p>First of all <a href="https://www.smashingmagazine.com/2017/04/guide-http2-server-push/" target="_blank">HTTP/2 server push</a> is not a push notification system for applications. You can use it to send additional cache-able resources to the client that is not requested, but it‚Äôs highly anticipated in future requests. Real quick example: if the client requests for an index.html file, you can push back the corresponding sytle.css and main.js files in the response, so they‚Äôll be there by the time the client actually needs them.</p><h3>Header compression, encryption, binary format, etc.</h3><p>I could continue with the <a href="https://medium.com/@jacobtan/understanding-http-2-and-its-caveats-1e8200519c4c" target="_blank">benefits of the HTTP/2</a> but I believe the most important factor here is speed. HTTP/2 has a lighter network footprint and also eliminates some security concerns which is great for everyone. You can read more about the protocol on other sites, but for now let‚Äôs just stop right here.</p><p>Let‚Äôs start creating our HTTP/2 server in Swift using Vapor 4! ü§ì</p><h2>SwiftNIO2 + Vapor4 = HTTP/2 support</h2><p>Apple‚Äôs cross-platform asynchronous event-driven network application framework supports HTTP/2 for a while. Vapor uses <a href="https://github.com/apple/swift-nio" target="_blank">SwiftNIO</a> since version 3, but only the 4th major version will have the brand new protocol support. Anyway it was a very long road, but we‚Äôre finally getting there and I‚Äôm really glad that this is happening now.</p><p>Both Swift, SwiftNIO and Vapor matured a lot in the past few years, if you‚Äôd like to spend more time on the server-side now it‚Äôs the best time to start learning these technologies and frameworks. <a href="https://theswiftdev.com/2019/08/26/whats-new-in-vapor-4/" target="_blank">Vapor 4 is going to be amazing</a>, and I hope that server-side Swift apps will dominate the market in a few years. #swifttotalworlddomination</p><blockquote><p>Backend language ‚Äúhype‚Äù evolution: PHP -> node.js -> Swift?</p></blockquote><h3>Project setup</h3><p>As usual, let‚Äôs start by creating a brand new project using the <a href="https://docs.vapor.codes/4.0/" target="_blank">Vapor toolbox</a>:</p><pre><code class="language-sh">vapor new HTTP2Server
cd HTTP2Server
vapor update -y
</code></pre><p>This will give you a starter Xcode project template, based on the latest Vapor 4 branch. If you are completely new to Vapor, you should read my <a href="https://theswiftdev.com/beginners-guide-to-server-side-swift-using-vapor-4/" target="_blank">beginners tutorial about Vapor</a> to get a basic understanding of the main components of the framework.</p><p>If you have an issue with Vapor, you should join the official <a href="https://discord.gg/BnXmVGA" target="_blank">Discord server</a>, you‚Äôll find some surprisingly good stuff and a really helpful community there. üòä</p><h3>Certificate generation</h3><p>Also because HTTP/2 is a secure protocol by default, you‚Äôll need your own SSL certificate. You can generate a self-signed <code>cert.pem</code> and a <code>key.pem</code> files with the following command (fill out the details with some fake data and press enter). üîê</p><pre><code class="language-sh">openssl req -newkey rsa:2048 -new -nodes -x509 -days 3650 -keyout key.pem -out cert.pem
</code></pre><p>That‚Äôs it, you should use these files for testing purposes only, also you still have to trust this self-signed local certificate. Your browser will tell you how to do it. ü§∑‚Äç‚ôÇÔ∏è</p><h3>Vapor 4 configuration with HTTP/2 support</h3><p>In order to enable HTTP/2 support in Vapor 4, you have to register a new HTTPServer Configuration service. You can do this in the configure.swift file.</p><pre><code class="language-swift">import Vapor
import NIOSSL

public func configure(_ app: Application) throws {

    // access home directory:
    // let homePath = NSString(string: "~").expandingTildeInPath

    // use .env file to provide cert / key paths:
    // let certPath = Environment.get("CERT_PATH")!
    // let keyPath = Environment.get("KEY_PATH")!

    let homePath = app.directory.workingDirectory
    let certPath = homePath + "/cert.pem"
    let keyPath = homePath + "/key.pem"

    let certs = try! NIOSSLCertificate.fromPEMFile(certPath)
        .map { NIOSSLCertificateSource.certificate($0) }

    let tls = TLSConfiguration.forServer(
        certificateChain: certs, 
        privateKey: .file(keyPath)
    )

    app.http.server.configuration = .init(
        hostname: "127.0.0.1",
        port: 8080,
        backlog: 256,
        reuseAddress: true,
        tcpNoDelay: true,
        responseCompression: .disabled,
        requestDecompression: .disabled,
        supportPipelining: false,
        supportVersions: Set<HTTPVersionMajor>([.two]),
        tlsConfiguration: tls,
        serverName: nil,
        logger: nil
    )
}
</code></pre><p>First you have to load your certificate chain with the corresponding private key file. Next you have to make a proper TLS configuration using the SSL certificate. The last thing that you have to create is a new HTTP configuration object.</p><p>If you run the project and accept the self-signed certificate you should see in the inspector that the protocol is <code>h2</code>, which means HTTP/2 is alive. Congratulations! üéâ</p><p><img src="vapor-http-2-response.jpg" alt="Vapor HTTP/2 response"></p><p>As you can see this article is more like a quick starting point to get HTTP/2 up and running in Vapor 4. Please share the article if you liked it & subscribe to my monthly newsletter below. Thanks for your help, bye! üôè</p>
        
    </section>
    
    <h2>Next</h2>
    
    <h2>Prev</h2>
        <div class="post card">
            <a href="/posts/hummingbird-routing-and-requests/" target="">
                <figure>
                    <picture>
                        <img
                            src=""
                            alt=""
                            title=""
                        >
                    </picture>
                </figure>
                <section>
                    <time datetime="2023-03-17 16:20:00">2023-03-17 16:20:00</time>
                    <h2 class="title">Hummingbird routing and requests</h2>
                </section>
                <p>Beginner&#39;s guide to learn all about routing and request handling using the Hummingbird server-side Swift framework.</p>
            </a>
        
            
            
        
        </div>
    
    <h2>Related</h2>
    Empty.
    
    <h2>More by author(s)</h2>
    Empty.

</article>

    </main>

    <footer id="page-footer">
        <section class="content-wrapper">
            <figure>
                <picture>
                    <source
                        srcset="/images/logos/logo~dark.png"
                        media="(prefers-color-scheme: dark)"
                    >
                    <img
                        id="logo-image"
                        src="/images/logos/logo.png"
                        alt="Logo of "
                        title=""
                    >
                </picture>
            </figure>
    
            <p>This site was generated using the <a href="https://swift.org/" target="_blank">Swift</a> programming language.</p>
            
            <p>
                <a href="https://binarybirds.com/">Home</a> ¬∑
                <a href="mailto:binarybirdsofficial@gmail.com">Email</a> ¬∑
                <a href="https://github.com/binarybirds/">GitHub</a> ¬∑
                <a href="https://x.com/tiborbodecs">Twitter</a> ¬∑
                <a href="/rss.xml" target="_blank">RSS</a> ¬∑
                <a href="/sitemap.xml" target="_blank">Sitemap</a>
            </p>
    
            <p class="small"> &copy; 2022 - 2024.</p>
        </section>
    </footer>
</body>
</html>
